#!/bin/bash

# Stop on first error
set -e

SCRIPTS_DIR=$(dirname "$0")
ROOT_DIR=$SCRIPTS_DIR/../..
OUT_DIR=$ROOT_DIR/out
RUN_DIR=$OUT_DIR/run
SOURCE_DIR=$ROOT_DIR/Source
GLOBAL_PACKAGES_DIR=~/.soup/packages
GLOBAL_OUT_DIR=~/.soup/out

SOUP_VERSION="0.34.0"
COPY_VERSION="1.0.0"
MKDIR_VERSION="1.0.0"
SOUP_CPP_VERSION="0.8.2"
SOUP_CSHARP_VERSION="0.9.0"
SOUP_WREN_VERSION="0.2.0"

# Cleanup previous runs
rm -rf $RUN_DIR
mkdir -p $RUN_DIR

cp $OUT_DIR/Cpp/Soup/$SOUP_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/bin/Soup.exe $RUN_DIR/soup
cp $OUT_DIR/Cpp/Soup/$SOUP_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/bin/Soup.Generate.exe $RUN_DIR/generate

mkdir -p $RUN_DIR/BuiltIn/copy/$COPY_VERSION
cp $SOURCE_DIR/Tools/Copy/Recipe.sml $RUN_DIR/BuiltIn/copy/$COPY_VERSION/Recipe.sml
cp -R $OUT_DIR/Cpp/copy/$COPY_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/ $RUN_DIR/BuiltIn/copy/$COPY_VERSION/out/

mkdir -p $RUN_DIR/BuiltIn/mkdir/$MKDIR_VERSION
cp $SOURCE_DIR/Tools/Mkdir/Recipe.sml $RUN_DIR/BuiltIn/mkdir/$MKDIR_VERSION/Recipe.sml
cp -R $OUT_DIR/Cpp/mkdir/$MKDIR_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/ $RUN_DIR/BuiltIn/mkdir/$MKDIR_VERSION/out/

mkdir -p $RUN_DIR/BuiltIn/Soup.Cpp/$SOUP_CPP_VERSION
cp $GLOBAL_PACKAGES_DIR/Wren/Soup.Cpp/$SOUP_CPP_VERSION/Recipe.sml $RUN_DIR/BuiltIn/Soup.Cpp/$SOUP_CPP_VERSION/Recipe.sml
cp -R $GLOBAL_OUT_DIR/Wren/Soup.Cpp/$SOUP_CPP_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/ $RUN_DIR/BuiltIn/Soup.Cpp/$SOUP_CPP_VERSION/out/

mkdir -p $RUN_DIR/BuiltIn/Soup.CSharp/$SOUP_CSHARP_VERSION
cp $GLOBAL_PACKAGES_DIR/Wren/Soup.CSharp/$SOUP_CSHARP_VERSION/Recipe.sml $RUN_DIR/BuiltIn/Soup.CSharp/$SOUP_CSHARP_VERSION/Recipe.sml
cp -R $GLOBAL_OUT_DIR/Wren/Soup.CSharp/$SOUP_CSHARP_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/ $RUN_DIR/BuiltIn/Soup.CSharp/$SOUP_CSHARP_VERSION/out/

mkdir -p $RUN_DIR/BuiltIn/Soup.Wren/$SOUP_WREN_VERSION
cp $GLOBAL_PACKAGES_DIR/Wren/Soup.Wren/$SOUP_WREN_VERSION/Recipe.sml $RUN_DIR/BuiltIn/Soup.Wren/$SOUP_WREN_VERSION/Recipe.sml
cp -R $GLOBAL_OUT_DIR/Wren/Soup.Wren/$SOUP_WREN_VERSION/J_HqSstV55vlb-x6RWC_hLRFRDU/ $RUN_DIR/BuiltIn/Soup.Wren/$SOUP_WREN_VERSION/out/

cp -R $ROOT_DIR/Source/out/msbuild/bin/Soup.Build.PackageManager/Debug/net6.0/linux-x64/publish/ $RUN_DIR/PackageManager

eval $RUN_DIR/soup "$@"